x-bin-base: &bin-base
  restart: unless-stopped
  environment:
    - RUST_LOG=${RUST_LOG:-info}

services:
  gateway:
    <<: *bin-base
    container_name: gateway
    image: fabric/gateway:${VERSION:-dev}
    env_file:
      - ${REPO_ROOT}/config/docker/gateway.env
    volumes:
      - ${REPO_ROOT}/config/docker/gateway.toml:/app/config.toml:ro
      - ${OUTPUT_DIR}/rocksdb:/app/rocksdb
    expose:
      - "8080"
      - "8082"
    depends_on:
      - constraints-server
      - gateway-signer
    networks:
      - kurtosis

  constraints-server:
    <<: *bin-base
    container_name: constraints-server
    image: fabric/relay:${VERSION:-dev}
    env_file:
      - ${REPO_ROOT}/config/docker/relay.env
    volumes:
      - ${REPO_ROOT}/config/docker/relay.toml:/app/config.toml:ro
      - ${OUTPUT_DIR}/rocksdb:/app/rocksdb
    expose:
      - "9998"
    ports:
      - "9998:9998"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9998/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - kurtosis

  proposer:
    <<: *bin-base
    container_name: proposer-delegation-module
    image: fabric/proposer:${VERSION:-dev}
    env_file:
      - ${REPO_ROOT}/config/docker/proposer.env
    volumes:
      - ${REPO_ROOT}/config/docker/proposer.toml:/app/config.toml:ro
      - ${OUTPUT_DIR}/rocksdb:/app/rocksdb
    depends_on:
      - proposer-signer
      - constraints-server
    networks:
      - kurtosis

  spammer:
    <<: *bin-base
    image: fabric/spammer:${VERSION:-dev}
    env_file:
      - ${REPO_ROOT}/config/docker/spammer.env
    volumes:
      - ${REPO_ROOT}/config/docker/spammer.toml:/app/config.toml:ro
    environment:
      - SENDER_PRIVATE_KEY=0xbcdf20249abf0ed6d944c0288fad489e33f66b3960d9e6229c1cd214ed3bbe31
    depends_on:
      - gateway
    networks:
      - kurtosis

  proposer-signer:
    <<: *bin-base
    image: fabric/signer:${VERSION:-dev}
    env_file:
      - ${REPO_ROOT}/config/docker/proposer-signer.env
    volumes:
      - ${REPO_ROOT}/config/docker/proposer-signer.toml:/app/config.toml:ro
      - ${OUTPUT_DIR}/validator_keys:/app/data/keystores/keys:ro
      - ${OUTPUT_DIR}/validator_secrets:/app/data/keystores/secrets:ro
      - ${REPO_ROOT}/data/proxy:/app/data/proxy
    networks:
      - kurtosis

  gateway-signer:
    <<: *bin-base
    image: fabric/signer:${VERSION:-dev}
    env_file:
      - ${REPO_ROOT}/config/docker/gateway-signer.env
    volumes:
      - ${REPO_ROOT}/config/docker/gateway-signer.toml:/app/config.toml:ro
      - ${REPO_ROOT}/data/keystores/keys:/app/data/keystores/keys:ro
      - ${REPO_ROOT}/data/keystores/secrets:/app/data/keystores/secrets:ro
      - ${REPO_ROOT}/data/proxy:/app/data/proxy
    networks:
      - kurtosis

  constraints-builder:
    <<: *bin-base
    image: constraints-builder:latest
    container_name: constraints-builder
    volumes:
      - ${KURTOSIS_DIR}/data/genesis:/network-configs:ro
      - ${KURTOSIS_DIR}/data/jwt:/jwt:ro
      - reth-data:/data/reth
      - ${CONSTRAINTS_BUILDER_CONFIG}:/app/config.toml:ro
      - ${CONSTRAINTS_BUILDER_BLOCKLIST}:/app/blocklist.json:ro
    environment:
      - RUST_BACKTRACE=full
      - BOOTNODES_EL=${BOOTNODES_EL}
      - BOOTNODES_CL=${BOOTNODES_CL}
      - LIBP2P_ADDR=${LIBP2P_ADDR}
      - TRUSTED_PEER=${TRUSTED_PEER}
      - FEE_RECIPIENT=${FEE_RECIPIENT}
      - COINBASE_SECRET_KEY=0x53321db7c1e331d93a11a41d16f004d7ff63972ec8ec7c25db329728ceeb1710
    ports:
      - "8545:8545"   # JSON-RPC
      - "8546:8546"   # WebSocket
      - "30304:30303" # P2P (use different host port to avoid conflict)
    networks:
      - kurtosis

volumes:
  reth-data:
  lighthouse-data:
  
networks:
  kurtosis:
    external: true
    name: ${KURTOSIS_NETWORK:-kt-preconf-testnet}